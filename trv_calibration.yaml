---
blueprint:
  name: Calibrate TRV
  description: Use an external sensor to calibrate a TRV
  domain: automation
  input:
    trv_sensor:
      name: TRV
      description: the TRV to calibrate
      selector:
        entity:
          filter:
            - domain: climate
              integration: zha
              supported_features:
                - climate.ClimateEntityFeature.TARGET_TEMPERATURE
    remote_sensor:
      name: Remote Sensor
      description: the sensor to hook to this TRV
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature
    local_offset:
      name: Offset via Zigbee
      description: >
          the offset on the radiator TRV,
          we have to ask as not predictable
      selector:
        entity:
          filter:
            - domain: number
              integration: zha
    threshold:
      name: Threshold for making changes
      description: >
          changes in temperature offset of less than this are ignored.
          This number must be positive as it compared to abs(old-new)
      default: 0.2
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
          unit_of_measurement: "Â°C"

variables:
  local_offset: !input local_offset
  remote_sensor: !input remote_sensor
  trv_sensor: !input trv_sensor
  threshold: !input threshold
  old_offset: |
    {{ states(local_offset)|float(16) }}
  new_offset: |
    {{ (states(remote_sensor)|float(16) -
       ( state_attr (trv_sensor, 'current_temperature')|float(16) -
         old_offset ))|round(precision=1) }}
  offset_changed: |
    {{ (old_offset - new_offset)|abs >= threshold }}

triggers:
  - trigger: state
    entity_id:
      - !input remote_sensor
    for:
      seconds: 30
  - trigger: state
    entity_id:
      - !input trv_sensor
    attribute: current_temperature
    for:
      seconds: 30

conditions: "{{ offset_changed }}"

actions:
  - action: number.set_value
    metadata: {}
    data:
      value: "{{ new_offset }}"
    target:
      entity_id: "{{ local_offset }}"
  - delay:
      minutes: 1
